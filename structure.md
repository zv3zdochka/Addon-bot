Ниже приведён обновлённый вариант с добавленным упоминанием о предзагруженной модели для распознавания русского языка с помощью Vosk:

---

### 1. Архитектурное описание бота

Чат-бот для Telegram представляет собой гибридную систему, которая сочетает в себе обработку простых запросов с использованием AIML (Artificial Intelligence Markup Language) и генерацию более сложных, контекстуальных ответов с помощью модели gpt-4o-mini. Для обработки голосовых сообщений используется библиотека Vosk, обеспечивающая оффлайн-распознавание речи. **Для распознавания русского языка используется предзагруженная модель, которая хранится в директории `model`.** Основной каркас бота построен на библиотеке `python-telegram-bot`, которая отвечает за взаимодействие с Telegram API.

**Основные компоненты архитектуры:**
- **Входной уровень**: Приём текстовых и голосовых сообщений через Telegram API.
- **Обработка голосовых сообщений**: Конвертация аудио из формата OGG в WAV с помощью `ffmpeg` и распознавание речи через Vosk.
- **Обработка текста**: 
  - Простые запросы обрабатываются AIML на основе предопределённых шаблонов (файл `advertisement.aiml`).
  - Сложные запросы передаются модели gpt-4o-mini с учётом истории диалога, хранящейся в памяти.
- **Выходной уровень**: Генерация и отправка ответов пользователю через Telegram API.

Бот поддерживает команды `/new_bot` для начала нового диалога и `/download_conv` для скачивания истории разговора в виде текстового файла. История диалогов хранится в оперативной памяти в словаре `user_history`.

---

### 2. Обоснование выбора технологий

Для реализации бота были выбраны следующие технологии, каждая из которых обоснована с точки зрения функциональности и удобства разработки:

- **python-telegram-bot**:
  - Причина: Популярная библиотека с хорошей документацией и активной поддержкой сообщества. Обеспечивает простую интеграцию с Telegram API.
  - Преимущества: Удобство настройки обработчиков сообщений и команд, поддержка асинхронных операций.

- **AIML**:
  - Причина: Используется для быстрой обработки предопределённых шаблонов диалогов (например, приветствия или реклама товаров).
  - Преимущества: Простота реализации, высокая скорость ответа на стандартные запросы, не требует больших вычислительных ресурсов.

- **gpt-4o-mini**:
  - Причина: Применяется для генерации естественных и контекстуальных ответов в случаях, когда AIML не справляется.
  - Преимущества: Высокое качество генерации текста, способность учитывать историю диалога, что делает общение более естественным.

- **Vosk**:
  - Причина: Используется для распознавания речи из голосовых сообщений.
  - Преимущества: Легковесность, работа в оффлайн-режиме, поддержка русского языка за счёт использования предзагруженной модели, высокая точность распознавания.

- **ffmpeg**:
  - Причина: Необходим для конвертации голосовых сообщений из OGG (формат Telegram) в WAV (формат, поддерживаемый Vosk).
  - Преимущества: Надёжный инструмент с широкими возможностями обработки аудио.

Эти технологии вместе обеспечивают баланс между простотой реализации, производительностью и качеством взаимодействия с пользователем.

---

### 3. Проектирование базы данных

В текущей реализации бота база данных не используется. История диалогов хранится в оперативной памяти в словаре `user_history`, где ключом является идентификатор пользователя (`user_id`), а значением — список сообщений в формате `[{"role": "...", "content": "..."}]`.

---

### 4. Описание ключевых модулей

Бот состоит из трёх основных модулей, каждый из которых выполняет свою задачу:

#### 4.1. Обработка языка (распознавание речи)
- **Функциональность**: Преобразование голосовых сообщений в текст.
- **Реализация**:
  - Голосовое сообщение скачивается в формате OGG.
  - С помощью `ffmpeg` файл конвертируется в WAV.
  - Библиотека Vosk распознаёт текст из аудио с использованием модели, хранящейся в директории `model`. **Для распознавания русского языка используется предзагруженная модель.**
- **Особенности**: Поддерживаются моно-аудиофайлы с частотой дискретизации 8000, 16000, 32000, 44100 или 48000 Гц.

#### 4.2. Классификация намерений
- **Функциональность**: Определение, какой тип ответа требуется на запрос пользователя.
- **Реализация**:
  - AIML проверяет сообщение на соответствие шаблонам из файла `advertisement.aiml`. Например, на фразу "Привет" бот отвечает "Привет! Как дела?".
  - Если шаблон не найден, запрос передаётся модели gpt-4o-mini для обработки.
- **Особенности**: AIML отвечает мгновенно, но ограничен шаблонами; gpt-4o-mini работает медленнее, но гибче.

#### 4.3. Генерация ответов
- **Функциональность**: Формирование текста ответа для пользователя.
- **Реализация**:
  - AIML генерирует ответы на основе шаблонов (например, реклама товаров вроде "Конструктор LEGO Icons").
  - gpt-4o-mini создаёт ответы с учётом истории диалога, что делает их более естественными.

---

### 5. Интеграция с платформой Telegram

Бот интегрирован с Telegram через библиотеку `python-telegram-bot`:
- **Updater**: Отвечает за получение обновлений от Telegram API.
- **Dispatcher**: Распределяет входящие сообщения по обработчикам:
  - `CommandHandler` для команд `/new_bot` и `/download_conv`.
  - `MessageHandler` для текстовых (`Filters.text`) и голосовых (`Filters.voice`) сообщений.
- **Процесс работы**:
  1. Пользователь отправляет сообщение.
  2. Бот получает его через Telegram API.
  3. Сообщение обрабатывается (текст — напрямую, голос — через Vosk).
  4. Ответ отправляется обратно через Telegram API.

Токен бота (`TOKEN`) задан в коде и используется для аутентификации.

---

### 6. Графическая часть

#### 6.1. Архитектурная схема чат-бота
```
[Пользователь] --> [Telegram API] --> [Бот: python-telegram-bot]
    |                   |                   |
    |                   |                   +--> [Голосовое сообщение] --> [ffmpeg: OGG -> WAV] --> [Vosk: распознавание речи]
    |                   |                   |
    +--> [Сообщение] --> [Обработка] --> [AIML: шаблоны] --> [Ответ] --> [Telegram API] --> [Пользователь]
                        |                   |
                        |                   +--> [gpt-4o-mini: генерация] --> [Ответ] --> [Telegram API] --> [Пользователь]
                        |
                        +--> [История: user_history]
```
*Описание*: Пользователь отправляет сообщение (текст или голос). Голос преобразуется в текст через Vosk, затем обрабатывается AIML или gpt-4o-mini. Ответ отправляется через Telegram API.

#### 6.2. Диаграмма структуры базы данных
В текущей версии база данных отсутствует

#### 6.3. Схема взаимодействия компонентов
```
[Пользователь]
      |
[Telegram API]
      |
[python-telegram-bot]
      |         \
      |          [Vosk] <-- [ffmpeg]
      |             \
[AIML]           [Текст]
      \             /
       [gpt-4o-mini]
             |
       [Telegram API]
             |
       [Пользователь]
```
*Описание*: Взаимодействие начинается с Telegram API, затем голос обрабатывается Vosk, а текст — AIML или gpt-4o-mini. Ответ возвращается через Telegram API.

---